name: Build
on:
  pull_request:
  push:
    branches:
      - master
jobs:
  analyze-changes:
    name: Analyze changes
    runs-on: ubuntu-latest
    outputs:
      run-build: ${{steps.analysis.outputs.run-build}}
      run-format-check-c-cpp: ${{steps.analysis.outputs.run-format-check-c-cpp}}
      run-format-check-md: ${{steps.analysis.outputs.run-format-check-md}}
      changes-c-cpp: ${{steps.analysis.outputs.changes-c-cpp}}
      changes-md: ${{steps.analysis.outputs.changes-md}}
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0
      - name: Analyze changes
        id: analysis
        shell: bash
        run: |
          if [ ${{github.ref}} == refs/heads/master ]; then
            build=true
            format_check_c_cpp=true
            format_check_md=true
            changes_c_cpp=$(
              find . -type f \
              -iregex '^.*\.\(c\|cpp\|h\|hpp\|inl\)$' -and -not \
              -iregex '^\.\/externals.*$'
            )
            changes_md=$(find . -type f -iname '*.md')
          else
            build=$(
              git diff --name-only origin/master HEAD -- \
              ':!externals/*/*' ':!*.md' ':!.github/CODEOWNERS' ':!*LICENSE' \
              ':!.markdownlintrc' ':!.markdownlintignore' ':!.clang-format' \
              ':!.github/labels.yml' ':!.github/workflows/sync-labels.yml' \
              ':!.github/workflows/rebase.yml' ':!.github/dependabot.yml' \
              ':!.gitattributes' ':!.gitmodules' ':!.gitignore'
            )
            if [ -z "$build" ]; then
              build=false
            else
              build=true
            fi
            changes_c_cpp=$(
              git diff --diff-filter=d --name-only origin/master HEAD -- \
              ':!externals/*/*' '*.c' '*.cpp' '*.h' '*.hpp' '*.inl' \
              .clang-format
            )
            if [ -z "$changes_c_cpp" ]; then
              format_check_c_cpp=false
            else
              format_check_c_cpp=true
              changes_c_cpp=$(
                echo "$changes_c_cpp" | grep -v .clang-format || true
              )
            fi
            changes_md=$(
              git diff --diff-filter=d --name-only origin/master HEAD -- \
              '*.md' .markdownlintrc .markdownlintignore
            )
            if [ -z "$changes_md" ]; then
              format_check_md=false
            else
              format_check_md=true
              changes_md=$(echo "$changes_md" | grep -v .markdownlint || true)
            fi
          fi
          echo "Run build: $build"
          echo "Run format check (C/C++): $format_check_c_cpp"
          echo "Run format check (Markdown): $format_check_md"
          if [ -z "$changes_c_cpp" ]; then
            echo 'Changes (C/C++): [none]'
          else
            echo -e "Changes (C/C++):\n$changes_c_cpp"
          fi
          if [ -z "$changes_md" ]; then
            echo 'Changes (Markdown): [none]'
          else
            echo -e "Changes (Markdown):\n$changes_md"
          fi
          echo "::set-output name=run-build::$build"
          echo "::set-output name=run-format-check-c-cpp::$format_check_c_cpp"
          echo "::set-output name=run-format-check-md::$format_check_md"
          echo "::set-output name=changes-c-cpp::$changes_c_cpp"
          echo "::set-output name=changes-md::$changes_md"
  check-formatting-c-cpp:
    name: Check formatting (C/C++)
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run-format-check-c-cpp == 'true'
    runs-on: ubuntu-latest
    container: ghcr.io/wnproject/clang-format
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
      - name: Check formatting
        run: >
          echo "${{needs.analyze-changes.outputs.changes-c-cpp}}" |
          xargs clang-format --dry-run --Werror
  check-formatting-md:
    name: Check formatting (Markdown)
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run-format-check-md == 'true'
    runs-on: ubuntu-latest
    container: ghcr.io/wnproject/markdown-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
      - name: Check formatting
        run: >
          echo "${{needs.analyze-changes.outputs.changes-md}}" |
          xargs markdownlint
  build-android:
    name: Build Android
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run-build == 'true'
    runs-on: ubuntu-latest
    container: ghcr.io/wnproject/build-android
    strategy:
      fail-fast: false
      matrix:
        architecture: [armeabi-v7a, arm64-v8a, x86]
        build-type: [Debug, Release]
    steps:
      - name: Set up build environment
        run: mkdir build
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          path: ./source
          submodules: true
      - name: Set up gcs key
        shell: bash
        run: echo "$GCS_KEY" > /tmp/gcs_key.json
        env:
          GCS_KEY: ${{secrets.SCCACHE_GCS_KEY}}
      - name: Run configuration
        working-directory: ./build
        run: >
          cmake -GNinja
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DCMAKE_TOOLCHAIN_FILE=${OVERLAY}/android.toolchain.cmake
          -DWN_ANDROID_ABIS=${{matrix.architecture}}
          -DWN_ANDROID_SDK=/opt/android-sdk
          -DWN_LOW_RESOURCE_MODE=ON
          -DWN_USE_SCCACHE=ON
          ../source
        env:
          OVERLAY: ${{github.workspace}}/source/Overlays/Posix/Overlays/Android
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: Run build (host tools)
        working-directory: ./build/host/externals/llvm-project/llvm
        run: cmake --build . --target llvm-tblgen
        env:
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: 'Run build (platform: ${{matrix.architecture}})'
        working-directory: ./build/${{matrix.architecture}}
        run: cmake --build .
        env:
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: Run build (apks)
        working-directory: ./build
        run: cmake --build .
        env:
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: Run tests
        working-directory: ./build
        run: >
          ctest -C ${{matrix.build-type}}
          -LE REQUIRES_HARDWARE --output-on-failure
      - name: Report build details
        if: success() || failure()
        run: du -hbcs ./source ./build
  build-linux:
    name: Build Linux
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run-build == 'true'
    runs-on: ubuntu-latest
    container: ghcr.io/wnproject/build-linux:${{matrix.compiler}}
    strategy:
      fail-fast: false
      matrix:
        compiler: [clang-9, clang-10, gcc-9, gcc-10]
        build-type: [Debug, Release]
    steps:
      - name: Set up build environment
        run: mkdir build
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          path: ./source
          submodules: true
      - name: Set up gcs key
        shell: bash
        run: echo "$GCS_KEY" > /tmp/gcs_key.json
        env:
          GCS_KEY: ${{secrets.SCCACHE_GCS_KEY}}
      - name: Run configuration
        working-directory: ./build
        run: >
          cmake -GNinja
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DWN_USE_SCCACHE=ON
          ../source
        env:
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: Run build
        working-directory: ./build
        run: cmake --build .
        env:
          SCCACHE_GCS_BUCKET: ${{secrets.SCCACHE_GCS_BUCKET}}
          SCCACHE_GCS_KEY_PATH: /tmp/gcs_key.json
          SCCACHE_GCS_RW_MODE: READ_WRITE
      - name: Run tests
        working-directory: ./build
        run: >
          ctest -C ${{matrix.build-type}}
          -LE REQUIRES_HARDWARE --output-on-failure
      - name: Report build details
        if: success() || failure()
        run: du -hbcs ./source ./build
  build-windows:
    name: Build Windows
    needs: analyze-changes
    if: needs.analyze-changes.outputs.run-build == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [msvc-15, msvc-16]
        build-type: [Debug, Release]
    steps:
      - name: Set up build environment
        id: build-environment
        run: |
          mkdir build
          $package = 'ghcr.io/wnproject/build-windows'
          $docker_image = "${package}:${{matrix.compiler}}".ToLower()
          echo "::set-output name=docker-image::$docker_image"
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          path: ./source
          submodules: true
      - name: Set up gcs key
        shell: bash
        run: echo "$GCS_KEY" > gcs_key.json
        env:
          GCS_KEY: ${{secrets.SCCACHE_GCS_KEY}}
      - name: Pull container
        run: docker pull ${{steps.build-environment.outputs.docker-image}}
      - name: Run configuration
        run: >
          docker run --rm
          -e SCCACHE_GCS_BUCKET=${{secrets.SCCACHE_GCS_BUCKET}}
          -e SCCACHE_GCS_KEY_PATH=C:\workspace\gcs_key.json
          -e SCCACHE_GCS_RW_MODE=READ_WRITE
          -v ${{github.workspace}}:C:\workspace
          ${{steps.build-environment.outputs.docker-image}}
          cmake -GNinja -S C:\workspace\source -B C:\workspace\build
          -DCMAKE_BUILD_TYPE=${{matrix.build-type}}
          -DWN_LOW_RESOURCE_MODE=ON
          -DWN_USE_SCCACHE=ON
      - name: Run build
        run: >
          docker run --rm
          -e SCCACHE_GCS_BUCKET=${{secrets.SCCACHE_GCS_BUCKET}}
          -e SCCACHE_GCS_KEY_PATH=C:\workspace\gcs_key.json
          -e SCCACHE_GCS_RW_MODE=READ_WRITE
          -v ${{github.workspace}}:C:\workspace
          ${{steps.build-environment.outputs.docker-image}}
          cmake --build C:\workspace\build
      - name: Run tests
        run: >
          docker run --rm
          -v ${{github.workspace}}:C:\workspace
          ${{steps.build-environment.outputs.docker-image}}
          "cd C:\workspace\build;
          ctest -C ${{matrix.build-type}}
          -LE REQUIRES_HARDWARE
          --output-on-failure"
      - name: Report build details
        if: success() || failure()
        shell: bash
        run: du -hbcs ./source ./build
  build:
    name: Build
    needs:
      - build-android
      - build-linux
      - build-windows
    if: success() || failure()
    runs-on: ubuntu-latest
    steps:
      - name: Accumulate build status
        shell: bash
        run: |
          results=( ${{join(needs.*.result, ' ')}} )
          for result in "${results[@]}"; do
            if [ "$result" != success ]; then
              echo Oh no...☹️ the build failed!
              exit 1
            fi
          done
          echo Yay! The build succeeded! 🎉
